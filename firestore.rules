rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profile data, accessible only by the user themselves.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile at /users/user123.
     * @allow (get) User with UID 'user123' can read their profile at /users/user123.
     * @allow (update) User with UID 'user123' can update their profile at /users/user123.
     * @allow (delete) User with UID 'user123' can delete their profile at /users/user123.
     * @deny (create) User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (get) User with UID 'user456' cannot read user123's profile at /users/user123.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, validates relational integrity between documents.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages store data, accessible only by the store owner.
     * @path /stores/{storeId}
     * @allow (create) User with UID 'user123' can create a store with ownerId 'user123'.
     * @allow (get) Any user can read store data.
     * @allow (update) User with UID 'user123' can update the store with ownerId 'user123'.
     * @allow (delete) User with UID 'user123' can delete the store with ownerId 'user123'.
     * @deny (create) User with UID 'user456' cannot create a store with ownerId 'user123'.
     * @deny (update) User with UID 'user456' cannot update the store with ownerId 'user123'.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /stores/{storeId} {
        function isOwner() {
            return request.auth.uid == resource.data.ownerId;
        }

        function isCreatingAsOwner() {
          return request.auth.uid == request.resource.data.ownerId;
        }

        allow get, list: if true;
        allow create: if isCreatingAsOwner();
        allow update: if isOwner();
        allow delete: if isOwner();
    }

    /**
     * @description Manages product data within a store, accessible only by the store owner.
     * @path /stores/{storeId}/products/{productId}
     * @allow (create) User with UID 'user123' can create a product in store 'store456' if the store's ownerId is 'user123'.
     * @allow (get) Any user can read product data.
     * @allow (update) User with UID 'user123' can update a product in store 'store456' if the store's ownerId is 'user123'.
     * @allow (delete) User with UID 'user123' can delete a product in store 'store456' if the store's ownerId is 'user123'.
     * @deny (create) User with UID 'user456' cannot create a product in store 'store456' if the store's ownerId is 'user123'.
     * @deny (update) User with UID 'user456' cannot update a product in store 'store456' if the store's ownerId is 'user123'.
     * @principle Enforces document ownership for writes on subcollections, allows public reads.
     */
    match /stores/{storeId}/products/{productId} {
      function isStoreOwner(storeId) {
          return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isStoreOwner(storeId);
      allow update: if isStoreOwner(storeId);
      allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Manages monthly package deals for a specific store, accessible only by the store owner.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (create) User with UID 'user123' can create a package in store 'store456' if the store's ownerId is 'user123'.
     * @allow (get) Any user can read package data.
     * @allow (update) User with UID 'user123' can update a package in store 'store456' if the store's ownerId is 'user123'.
     * @allow (delete) User with UID 'user123' can delete a package in store 'store456' if the store's ownerId is 'user123'.
     * @deny (create) User with UID 'user456' cannot create a package in store 'store456' if the store's ownerId is 'user123'.
     * @deny (update) User with UID 'user456' cannot update a package in store 'store456' if the store's ownerId is 'user123'.
     * @principle Enforces document ownership for writes on subcollections, allows public reads.
     */
    match /stores/{storeId}/packages/{packageId} {
      function isStoreOwner(storeId) {
          return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isStoreOwner(storeId);
      allow update: if isStoreOwner(storeId);
      allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Manages order data, with access control based on user and store ownership.
     * @path /orders/{orderId}
     * @allow (create) Any authenticated user can create an order.
     * @allow (get) Any authenticated user can read an order.
     * @allow (update) Only the user who created the order can update it.
     * @allow (delete) Only the user who created the order can delete it.
     * @deny (create) Unauthenticated users cannot create orders.
     * @deny (update) Other users cannot update orders they did not create.
     * @principle Allows order creation by any user, restricts updates and deletes to the order creator.
     */
    match /orders/{orderId} {
      function isOrderOwner() {
        return request.auth.uid == resource.data.userId;
      }

      function isCreatingAsOwner() {
        return request.auth.uid == request.resource.data.userId;
      }

      
      allow get, list: if true;
      allow create: if isCreatingAsOwner();
      allow update: if isOrderOwner();
      allow delete: if isOrderOwner();
    }

    /**
     * @description Manages voice-only order data.
     * @path /voice-orders/{voiceOrderId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if isSignedIn();
     * // TODO: Add owner validation once the schema is updated with an ownership field.
     * allow create, update, delete: if false;
     */
    match /voice-orders/{voiceOrderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update, delete: if false;
    }

    /**
     * @description Manages order item data within an order, accessible only by the order owner.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (create) User who owns the order can create order items.
     * @allow (get) Any user can read order item data.
     * @allow (update) User who owns the order can update order items.
     * @allow (delete) User who owns the order can delete order items.
     * @deny (create) Other users cannot create order items.
     * @deny (update) Other users cannot update order items.
     * @principle Enforces document ownership for writes on subcollections, allows public reads.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      function isOrderOwner(orderId) {
        return get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isOrderOwner(orderId);
      allow update: if isOrderOwner(orderId);
      allow delete: if isOrderOwner(orderId);
    }

    /**
     * @description Manages product recommendations for each user, accessible only by the user themselves.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (create) User with UID 'user123' can create a recommendation for themselves.
     * @allow (get) User with UID 'user123' can read their own recommendations.
     * @allow (update) User with UID 'user123' can update their own recommendations.
     * @allow (delete) User with UID 'user123' can delete their own recommendations.
     * @deny (create) User with UID 'user456' cannot create a recommendation for user 'user123'.
     * @deny (get) User with UID 'user456' cannot read recommendations for user 'user123'.
     * @principle Enforces document ownership for writes, restricts access to a user's own data.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores cached recipe ingredients to reduce AI usage.
     * @path /cachedRecipes/{recipeId}
     * @allow (get) Any user can read cached recipe data.
     * @allow (list) Any user can list cached recipe data.
     * @allow (create) Any authenticated user can create cached recipe data.
     * @allow (update) Any authenticated user can update cached recipe data.
     * @allow (delete) Any authenticated user can delete cached recipe data.
     * @principle Allows public reads for cached recipe data, authenticated access for writes.
     */
    match /cachedRecipes/{recipeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages delivery partner profiles, accessible only to the partner themselves.
     * @path /deliveryPartners/{partnerId}
     * @allow (create) User with UID 'user123' can create their profile as a delivery partner.
     * @allow (get) User with UID 'user123' can read their own delivery partner profile.
     * @allow (update) User with UID 'user123' can update their own delivery partner profile.
     * @allow (delete) User with UID 'user123' can delete their own delivery partner profile.
     * @deny (create) User with UID 'user456' cannot create a delivery partner profile for user 'user123'.
     * @deny (get) User with UID 'user456' cannot read the delivery partner profile of user 'user123'.
     * @principle Enforces document ownership for writes, restricts access to a user's own data.
     */
    match /deliveryPartners/{partnerId} {
      function isOwner(partnerId) {
        return request.auth.uid == partnerId;
      }

      function isExistingOwner(partnerId) {
          return isOwner(partnerId) && exists(resource);
      }

      allow get: if isOwner(partnerId);
      allow list: if false;
      allow create: if isOwner(partnerId);
      allow update: if isOwner(partnerId);
      allow delete: if isOwner(partnerId);
    }

    /**
     * @description Stores payout requests for delivery partners, accessible only to the partner.
     * @path /deliveryPartners/{partnerId}/payouts/{payoutId}
     * @allow (create) Delivery partner with ID 'user123' can create a payout request.
     * @allow (get) Delivery partner with ID 'user123' can read their own payout requests.
     * @allow (update) Delivery partner with ID 'user123' can update their own payout requests.
     * @allow (delete) Delivery partner with ID 'user123' can delete their own payout requests.
     * @deny (create) Delivery partner with ID 'user456' cannot create payout requests for 'user123'.
     * @deny (get) Delivery partner with ID 'user456' cannot read payout requests for 'user123'.
     * @principle Enforces document ownership for writes, restricts access to a user's own data.
     */
    match /deliveryPartners/{partnerId}/payouts/{payoutId} {
      function isPartner(partnerId) {
        return get(/databases/$(database)/documents/deliveryPartners/$(partnerId)).data.userId == request.auth.uid;
      }

      allow get: if isPartner(partnerId);
      allow list: if false;
      allow create: if isPartner(partnerId);
      allow update: if isPartner(partnerId);
      allow delete: if isPartner(partnerId);
    }
  }
}