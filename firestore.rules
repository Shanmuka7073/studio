/**
 * @fileoverview Firestore Security Rules for LocalBasket.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where users own their data,
 * stores own their products and orders, and access is generally restricted
 * based on ownership or explicit relationships.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user.
 * - /stores/{storeId}: Store information, accessible by anyone, but only the owner can modify.
 * - /stores/{storeId}/products/{productId}: Products listed by a store, publicly readable, but only the store owner can modify.
 * - /orders/{orderId}: Order information, publicly readable, but only the store owner can modify.
 * - /voice-orders/{voiceOrderId}: Voice-only orders, publicly readable, no modification allowed.
 * - /orders/{orderId}/orderItems/{orderItemId}: Items within an order, publicly readable, no modification allowed.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Product recommendations for a user, only accessible and modifiable by the user.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data.
 * - Stores have full control over their products.
 * - Orders can be read by anyone but only stores can manage their own orders based on the denormalized storeId.
 * - Listing of users is disallowed for privacy.
 * - Voice orders and OrderItems are read-only.
 * - Data validation is relaxed in this prototype for rapid iteration.
 *
 * Denormalization for Authorization:
 * - The 'Order' entity includes 'storeId' to allow stores to easily query and manage their orders.
 * - The 'OrderItem' entity includes 'orderId' for authorization independence.
 * - The 'ProductRecommendation' entity includes 'userId' for authorization independence.
 *
 * Structural Segregation:
 * - Private user data is stored under /users/{userId} to ensure it's only accessible by the user.
 * - Public data like products are available to anyone.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows the owner to read their own data.
     * @path /users/{userId}
     * @allow (get, list) User with matching userId.
     * @deny (get, list) User with non-matching userId.
     * @principle Enforces document ownership for reads.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not allowed.
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read stores, but only owners to create, update, or delete.
     * @path /stores/{storeId}
     * @allow (get, list) Any user.
     * @allow (create) Store with matching ownerId.
     * @deny (create) Store with non-matching ownerId.
     * @allow (update, delete) Store with matching ownerId.
     * @deny (update, delete) Store with non-matching ownerId.
     * @principle Enforces document ownership for writes.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read products, but only stores to create, update, or delete their own products.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get, list) Any user.
     * @allow (create) Store owner.
     * @deny (create) Non-store owner.
     * @allow (update, delete) Store owner.
     * @deny (update, delete) Non-store owner.
     * @principle Enforces document ownership for writes.
     */
    match /stores/{storeId}/products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read order information, but only store owners to create, update, or delete their orders.
     * @path /orders/{orderId}
     * @allow (get, list) Any user.
     * @allow (create) Store owner.
     * @deny (create) Non-store owner.
     * @allow (update, delete) Store owner.
     * @deny (update, delete) Non-store owner.
     * @principle Enforces document ownership for writes based on denormalized storeId.
     */
    match /orders/{orderId} {
      allow get: if true;
      allow list: if isSignedIn() && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/stores/$(request.resource.data.storeId)).data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows reading voice orders.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get, list) Any user.
     * @deny (create, update, delete) No one.
     */
    match /voice-orders/{voiceOrderId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows reading order items.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) Any user.
     * @deny (create, update, delete) No one.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows the owner to manage product recommendations.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get, list, create, update, delete) User with matching userId.
     * @deny (get, list, create, update, delete) User with non-matching userId.
     * @principle Enforces document ownership for product recommendations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}