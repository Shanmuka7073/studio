/**
 * @fileoverview Firestore Security Rules for LocalBasket application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and store data.
 * Orders and recommendations are also linked to users, ensuring data privacy.
 * All other data is publicly readable, but write access is restricted to authorized users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, accessible only to the user.
 * - /stores/{storeId}: Stores store details, owned by a specific user (ownerId).
 * - /stores/{storeId}/products/{productId}: Stores product details for a store.
 * - /stores/{storeId}/packages/{packageId}: Stores monthly package deals for a store.
 * - /orders/{orderId}: Stores order information, linked to a user and a store.
 * - /voice-orders/{voiceOrderId}: Stores voice-only order details.
 * - /orders/{orderId}/orderItems/{orderItemId}: Stores individual items within an order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Stores product recommendations for a user.
 * - /cachedRecipes/{recipeId}: Stores cached recipe ingredients to reduce AI usage.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data under /users/{userId}.
 * - Stores can be created, updated, and deleted only by their owners.
 * - Listing all documents at the root level is denied.
 * - Public read access is granted for stores, products, packages, orders, voice orders, order items, product recommendations, and cached recipes.
 *
 * Denormalization for Authorization:
 * - The 'Store' entity contains an 'ownerId' field to easily check ownership.
 * - The 'Order' entity contains 'userId' and 'storeId' for easier querying and security rules.
 * - The 'ProductRecommendation' and 'OrderItem' entities contain denormalized 'userId' and 'orderId' respectively for authorization independence.
 *
 * Structural Segregation:
 *  N/A
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that only the authenticated user can access their own user document.
     * @path /users/{userId}
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create their profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @allow (get) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can read their profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @allow (update) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can update their profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @allow (delete) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can delete their profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @deny (create) User 'otherUser' cannot create a profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @deny (get) User 'otherUser' cannot read the profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @deny (update) User 'otherUser' cannot update the profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @deny (delete) User 'otherUser' cannot delete the profile at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to stores, but restricts write access to the store owner.
     * @path /stores/{storeId}
     * @allow (get) Any user can read a store's data at /stores/someStoreId.
     * @allow (list) Any user can list stores.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create a store at /stores/someStoreId if request.resource.data.ownerId matches their uid.
     * @allow (update) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can update a store at /stores/someStoreId if they are the owner.
     * @allow (delete) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can delete a store at /stores/someStoreId if they are the owner.
     * @deny (create) User 'otherUser' cannot create a store if request.resource.data.ownerId doesn't match their uid.
     * @deny (update) User 'otherUser' cannot update a store they don't own.
     * @deny (delete) User 'otherUser' cannot delete a store they don't own.
     * @principle Enforces public read access with owner-only writes.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows public read access to products, but restricts write access to the store owner.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get) Any user can read a product's data at /stores/someStoreId/products/someProductId.
     * @allow (list) Any user can list products under a store.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create a product at /stores/someStoreId/products/someProductId if they own the store.
     * @allow (update) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can update a product at /stores/someStoreId/products/someProductId if they own the store.
     * @allow (delete) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can delete a product at /stores/someStoreId/products/someProductId if they own the store.
     * @deny (create) User 'otherUser' cannot create a product in a store they don't own.
     * @deny (update) User 'otherUser' cannot update a product in a store they don't own.
     * @deny (delete) User 'otherUser' cannot delete a product in a store they don't own.
     * @principle Enforces public read access with owner-only writes.
     */
    match /stores/{storeId}/products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }

      /**
     * @description Allows public read access to monthly packages, but restricts write access to the store owner.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (get) Any user can read a monthly package's data at /stores/someStoreId/packages/somePackageId.
     * @allow (list) Any user can list monthly packages under a store.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create a monthly package at /stores/someStoreId/packages/somePackageId if they own the store.
     * @allow (update) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can update a monthly package at /stores/someStoreId/packages/somePackageId if they own the store.
     * @allow (delete) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can delete a monthly package at /stores/someStoreId/packages/somePackageId if they own the store.
     * @deny (create) User 'otherUser' cannot create a monthly package in a store they don't own.
     * @deny (update) User 'otherUser' cannot update a monthly package in a store they don't own.
     * @deny (delete) User 'otherUser' cannot delete a monthly package in a store they don't own.
     * @principle Enforces public read access with owner-only writes.
     */
    match /stores/{storeId}/packages/{packageId} {
      allow get, list: if true;
     allow create: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows public read access to orders, but restricts write access.
     *  Creating an order requires a valid user and store, updating and deleting restricted to owner.
     * @path /orders/{orderId}
     * @allow (get) Any user can read an order's data at /orders/someOrderId.
     * @allow (list) Any user can list orders.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create an order at /orders/someOrderId.
     * @deny (update) User 'otherUser' cannot update an order.
     * @deny (delete) User 'otherUser' cannot delete an order.
     * @principle Enforces public read access. Write access is restricted to authenticated users with appropriate ownership.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && request.resource.data.userId == resource.data.userId;
    }

    /**
     * @description Allows public read access to voice orders, but restricts write access.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get) Any user can read a voice order's data at /voice-orders/someVoiceOrderId.
     * @allow (list) Any user can list voice orders.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create a voice order at /voice-orders/someVoiceOrderId.
     * @deny (update) User 'otherUser' cannot update a voice order.
     * @deny (delete) User 'otherUser' cannot delete a voice order.
     * @principle Enforces public read access.
     */
    match /voice-orders/{voiceOrderId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && request.resource.data.userId == resource.data.userId;
    }

    /**
     * @description Allows public read access to order items, but restricts write access.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get) Any user can read an order item's data at /orders/someOrderId/orderItems/someOrderItemId.
     * @allow (list) Any user can list order items under an order.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create an order item at /orders/someOrderId/orderItems/someOrderItemId.
     * @deny (update) User 'otherUser' cannot update an order item.
     * @deny (delete) User 'otherUser' cannot delete an order item.
     * @principle Enforces public read access.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if true;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
    }

    /**
     * @description Allows public read access to product recommendations, but restricts write access to the user.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get) Any user can read a product recommendation's data at /users/someUserId/productRecommendations/someProductRecommendationId.
     * @allow (list) The owner can list their own product recommendations.
     * @allow (create) User 'hD4jVD2bQFYI2wKD9uEVLSUw7zf2' can create a product recommendation at /users/hD4jVD2bQFYI2wKD9uEVLSUw7zf2/productRecommendations/someProductRecommendationId.
     * @deny (update) User 'otherUser' cannot update a product recommendation.
     * @deny (delete) User 'otherUser' cannot delete a product recommendation.
     * @principle Enforces public read access.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      allow get: if true;
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows public read access to cached recipes. Write access is denied for everyone.
     * @path /cachedRecipes/{recipeId}
     * @allow (get) Any user can read a cached recipe's data at /cachedRecipes/someRecipeId.
     * @allow (list) Any user can list cached recipes.
     * @deny (create) No one can create a cached recipe.
     * @deny (update) No one can update a cached recipe.
     * @deny (delete) No one can delete a cached recipe.
     * @principle Enforces public read access and denies all writes.
     */
    match /cachedRecipes/{recipeId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // Prohibit listing all documents in the database
    match /{path=**} {
      allow list: if false;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the resource.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is the existing owner of the resource, checking for existence.
  function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
  }

  // Helper function to determine if the user is the owner of the store (using a get() operation).
  function isStoreOwner(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
  }
}