/**
 * @fileOverview Firestore Security Rules for LocalBasket.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data and a public-read/owner-write model for store and product data. Authorization decisions are made independently based on denormalized data within documents, minimizing the need for costly `get()` calls.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, accessible only by the user themselves.
 * - /stores/{storeId}: Stores store data.
 * - /stores/{storeId}/products/{productId}: Stores product data for each store.
 * - /orders/{orderId}: Stores order information, with denormalized userId and storeId.
 * - /orders/{orderId}/orderItems/{orderItemId}: Stores order item information for each order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Stores product recommendations for each user.
 *
 * Key Security Decisions:
 * - User data is strictly private and accessible only by the authenticated user.
 * - Stores and Products are publicly readable, but only the owner can create, update, or delete them.  An `ownerId` or `authorId` field must be present in the document to establish ownership.
 * - Listing of product recommendations is only allowed by the owner.
 *
 * Denormalization for Authorization:
 * - Products include a `storeId` to allow rules to independently authorize access based on the store.
 * - Orders include `userId` and `storeId` to simplify querying and security rules.
 * - OrderItems include `orderId` for authorization independence.
 * - ProductRecommendations include `userId` for authorization independence.
 *
 * Structural Segregation:
 * - User profiles are stored under /users/{userId} for private access.
 * - Stores are stored in a separate /stores collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profile data only by the authenticated user.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create their own profile at /users/user_abc.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete their own profile at /users/user_abc.
     * @deny (create) - User with UID 'user_abc' cannot create a profile for another user at /users/user_xyz.
     * @deny (get, update, delete) - User with UID 'user_abc' cannot read, update, or delete another user's profile at /users/user_xyz.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to stores, but restricts create, update, and delete operations.
     * @path /stores/{storeId}
     * @allow (get, list) - Any user can read store data.
     * @deny (create, update, delete) - No one can create, update, or delete stores (owner validation is missing).
     * @principle Provides public read access while restricting write access.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to products, but restricts create, update, and delete operations.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get, list) - Any user can read product data.
     * @deny (create, update, delete) - No one can create, update, or delete products (owner validation is missing).
     * @principle Provides public read access while restricting write access.
     */
    match /stores/{storeId}/products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows access to order data, restricting create, update, and delete operations.
     * @path /orders/{orderId}
     * @allow (get, list) - Any user can read order data.
     * @deny (create, update, delete) - No one can create, update, or delete orders (owner validation is missing).
     * @principle Restricts access to order data.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows access to order item data, restricting create, update, and delete operations.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) - Any user can read order item data.
     * @deny (create, update, delete) - No one can create, update, or delete order items (owner validation is missing).
     * @principle Restricts access to order item data.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows access to product recommendation data only by the authenticated user.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (create, get, update, delete) - User with UID 'user_abc' can read, update, and delete their own product recommendations at /users/user_abc/productRecommendations/{productRecommendationId}.
     * @allow (list) - User with UID 'user_abc' can list their own product recommendations.
     * @deny (create, get, update, delete) - User with UID 'user_abc' cannot read, update, or delete another user's product recommendations at /users/user_xyz/productRecommendations/{productRecommendationId}.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}