/**
 * @fileoverview Firestore Security Rules for LocalBasket.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and
 * product recommendations. Orders can be created by any authenticated user,
 * but only the user who created the order can modify or delete it. Store
 * data can be created by any authenticated user, since it's assumed a role based system handles what stores the users manage.
 * Voice orders are publicly accessible.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, accessible only by the user themselves.
 * - /stores/{storeId}: Stores store data, accessible by anyone.
 * - /stores/{storeId}/products/{productId}: Stores product data, accessible by anyone.
 * - /orders/{orderId}: Stores order information. Orders are associated with a user ID and store ID, and accessible only by the user who created the order.
 * - /voice-orders/{voiceOrderId}: Stores voice order information, publicly accessible.
 * - /orders/{orderId}/orderItems/{orderItemId}: Stores order item information, accessible only by the user who created the parent order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Stores product recommendations, accessible only by the user themselves.
 *
 * Key Security Decisions:
 * - Users can only access their own user profile data.
 * - Users can create orders, but only modify or delete their own orders.
 * - Stores and Products are publicly accessible.
 * - Voice orders are publicly accessible.
 * - Product recommendations are private to each user.
 *
 * Denormalization for Authorization:
 * - The 'Order' entity includes 'userId' to allow for simpler, more performant rules
 *   that avoid the need for complex queries or function calls to determine
 *   order ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the existing resource.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (get) User 'user123' can read their own profile.
     * @allow (list) User 'user123' can list their own profile.
     * @allow (create) User 'user123' can create their own profile.
     * @allow (update) User 'user123' can update their own profile.
     * @allow (delete) User 'user123' can delete their own profile.
     * @deny (get) User 'user456' cannot read user 'user123's profile.
     * @deny (create) An unauthenticated user cannot create a profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for stores.
     * @path /stores/{storeId}
     * @allow (get) Any user can read store data.
     * @allow (list) Any user can list stores.
     * @allow (create) Any authenticated user can create a store.
     * @allow (update) Any authenticated user can update a store.
     * @allow (delete) Any authenticated user can delete a store.
     * @deny (create) An unauthenticated user cannot create a store.
     * @principle Allows any signed-in user to create and manage stores.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Rules for products within a store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get) Any user can read product data.
     * @allow (list) Any user can list products in a store.
     * @allow (create) Any authenticated user can create a product in a store.
     * @allow (update) Any authenticated user can update a product in a store.
     * @allow (delete) Any authenticated user can delete a product in a store.
     * @deny (create) An unauthenticated user cannot create a product.
     * @principle Allows any signed-in user to create and manage products within stores.
     */
    match /stores/{storeId}/products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Rules for orders.
     * @path /orders/{orderId}
     * @allow (get) The user who created the order can read it.
     * @allow (list) Any authenticated user can list orders.
     * @allow (create) Any authenticated user can create an order and the `userId` field must match the user's UID.
     * @allow (update) The user who created the order can update it.
     * @allow (delete) The user who created the order can delete it.
     * @deny (get) User 'user456' cannot read order 'order123' if they didn't create it.
     * @deny (create) An unauthenticated user cannot create an order.
     * @principle Orders can be created by any authenticated user, but only modified or deleted by the creator.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

    /**
     * @description Rules for voice orders.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get) Any user can read voice order data.
     * @allow (list) Any user can list voice orders.
     * @allow (create) Any user can create a voice order.
     * @allow (update) Any user can update a voice order.
     * @allow (delete) Any user can delete a voice order.
     * @principle Voice orders are publicly accessible.
     */
    match /voice-orders/{voiceOrderId} {
      allow get, list, create, update, delete: if true;
    }

    /**
     * @description Rules for order items.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get) The user who created the order can read the order items.
     * @allow (list) The user who created the order can list the order items.
     * @allow (create) The user who created the order can create an order item.
     * @allow (update) The user who created the order can update an order item.
     * @allow (delete) The user who created the order can delete an order item.
     * @deny (create) An unauthenticated user cannot create an order item.
     * @principle Only the owner of the parent order can manage order items.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
    }

    /**
     * @description Rules for product recommendations.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get) User 'user123' can read their own product recommendations.
     * @allow (list) User 'user123' can list their own product recommendations.
     * @allow (create) User 'user123' can create a product recommendation for themselves.
     * @allow (update) User 'user123' can update their own product recommendations.
     * @allow (delete) User 'user123' can delete their own product recommendations.
     * @deny (get) User 'user456' cannot read product recommendations for user 'user123'.
     * @deny (create) An unauthenticated user cannot create a product recommendation.
     * @principle Enforces document ownership for all operations on product recommendations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}