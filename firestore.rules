rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data. Only the user can read and write their own data.
     * @path /users/{userId}
     * @allow (create, update, get, delete, list) if the user is signed in and the requested userId matches their authentication UID (isOwner).
     * @deny (create, update, get, delete) if the user is not signed in or the requested userId does not match their authentication UID.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to store data. Only the store owner can create, read, update, and delete store data.
     * @path /stores/{storeId}
     * @allow (create, update, get, delete, list) if the user is signed in and the requested storeId's ownerId matches their authentication UID (isOwner).
     * @deny (create, update, get, delete) if the user is not signed in or the requested storeId's ownerId does not match their authentication UID.
     * @principle Enforces store ownership for store data.
     */
    match /stores/{storeId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingStoreOwner(storeId);
      allow delete: if isExistingStoreOwner(storeId);
    }

    /**
     * @description Controls access to product data. Only the store owner can create, read, update, and delete product data within their store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (create, update, get, delete, list) if the user is signed in and is the owner of the parent store.
     * @deny (create, update, get, delete) if the user is not signed in or is not the owner of the parent store.
     * @principle Enforces store ownership for product data.
     */
    match /stores/{storeId}/products/{productId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isStoreOwner(storeId);
      allow update: if isExistingStoreOwner(storeId);
      allow delete: if isExistingStoreOwner(storeId);
    }

    /**
     * @description Controls access to monthly package data. Only the store owner can create, read, update, and delete package data within their store.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (create, update, get, delete, list) if the user is signed in and is the owner of the parent store.
     * @deny (create, update, get, delete) if the user is not signed in or is not the owner of the parent store.
     * @principle Enforces store ownership for monthly package data.
     */
    match /stores/{storeId}/packages/{packageId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isStoreOwner(storeId);
      allow update: if isExistingStoreOwner(storeId);
      allow delete: if isExistingStoreOwner(storeId);
    }

    /**
     * @description Controls access to order data.  Anyone can read order data. Only the user who created the order or the store owner can modify it.
     * @path /orders/{orderId}
     * @allow (get, list) if true.
     * @allow (create) if the authenticated user's ID matches the order's userId.
     * @allow (update, delete) if the authenticated user is the order's user or the store owner.
     * @deny (create, update, delete) if the conditions above are not met.
     * @principle Allows public reads, restricts writes to the user who created the order and store owner.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isOrderOwner(orderId) || isStoreOwnerByOrder(orderId);
      allow delete: if isExistingOrderOwner(orderId) || isExistingStoreOwnerByOrder(orderId);
    }

    /**
     * @description Controls access to voice order data.
     * @path /voice-orders/{voiceOrderId}
     */
    match /voice-orders/{voiceOrderId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to order item data. Only users with access to the parent order can access order items.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOrderOwner(orderId) || isStoreOwnerByOrder(orderId);
      allow update: if isExistingOrderOwner(orderId) || isExistingStoreOwnerByOrder(orderId);
      allow delete: if isExistingOrderOwner(orderId) || isExistingStoreOwnerByOrder(orderId);
    }

    /**
     * @description Controls access to product recommendation data. Only the user can read and write their own recommendations.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

     /**
      * @description Controls access to cached recipe data.  Anyone can read this data.  Writes are not permitted.
      * @path /cachedRecipes/{recipeId}
      */
    match /cachedRecipes/{recipeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to delivery partner data. Only the partner can read and write their own data.
     * @path /deliveryPartners/{partnerId}
     */
    match /deliveryPartners/{partnerId} {
      allow get: if isOwner(partnerId);
      allow list: if false;
      allow create: if isOwner(partnerId);
      allow update: if isOwner(partnerId);
      allow delete: if isExistingOwner(partnerId);
    }

    /**
     * @description Controls access to payout data for delivery partners. Only the partner can read their own payout data.  Writes are not permitted.
     * @path /deliveryPartners/{partnerId}/payouts/{payoutId}
     */
    match /deliveryPartners/{partnerId}/payouts/{payoutId} {
      allow get: if isOwner(partnerId);
      allow list: if isOwner(partnerId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     match /orders/{orderId} {
        allow get: if isSignedIn() && (resource.data.deliveryPartnerId == request.auth.uid);
        allow update: if isSignedIn() && (request.resource.data.status == 'accepted') && (resource.data.deliveryPartnerId == request.auth.uid);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
    }

    function isStoreOwner(storeId) {
      return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }

    function isExistingStoreOwner(storeId) {
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && resource.data.ownerId == request.auth.uid;
    }

    function isOrderOwner(orderId) {
      return isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
    }

    function isExistingOrderOwner(orderId) {
        return isOrderOwner(orderId) && resource.data.userId == request.auth.uid;
    }

    function isStoreOwnerByOrder(orderId) {
        let storeId = get(/databases/$(database)/documents/orders/$(orderId)).data.storeId;
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }

     function isExistingStoreOwnerByOrder(orderId) {
        return isStoreOwnerByOrder(orderId) && resource.data.storeId == get(/databases/$(database)/documents/orders/$(orderId)).data.storeId;
    }
  }
}