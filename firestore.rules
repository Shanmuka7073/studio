/**
 * @file Firestore Security Rules for LocalBasket
 * @version 2
 *
 * @Core Philosophy
 * This ruleset enforces a strict user-ownership model for user profiles and store management.
 * Orders are secured with a combination of user and store ownership. Public read access is granted
 * to cached recipe data.
 *
 * @Data Structure
 * - /users/{userId}: User profile information, accessible only by the user themselves.
 * - /stores/{storeId}: Store data, accessible only by the store owner.
 * - /stores/{storeId}/products/{productId}: Products listed by a store, accessible only by the store owner.
 * - /stores/{storeId}/packages/{packageId}: Monthly packages offered by a store, accessible only by the store owner.
 * - /orders/{orderId}: Order information, accessible only by the user who placed the order.
 * - /voice-orders/{voiceOrderId}: Voice-only orders, currently accessible to anyone.
 * - /orders/{orderId}/orderItems/{orderItemId}: Items within an order, accessible only by the user who placed the order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Product recommendations for a user, accessible only by the user themselves.
 * - /cachedRecipes/{recipeId}: Publicly accessible cache of recipe ingredients.
 *
 * @Key Security Decisions
 * - Users can only access their own profile data.
 * - Stores can only be managed by their owners.
 * - Orders can only be accessed by the user who placed them.
 * - Voice orders are currently publicly accessible.
 * - Public read access is granted to the `/cachedRecipes` collection.
 * - Listing of users is disallowed.
 *
 * @Denormalization for Authorization
 * - Orders: 'userId' and 'storeId' are denormalized onto the Order document for simpler authorization.
 * - OrderItems: 'orderId' is denormalized onto the OrderItem document for authorization.
 * - ProductRecommendations: 'userId' is denormalized onto the ProductRecommendation document.
 *
 * @Structural Segregation
 * - No structural segregation is used in this ruleset.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data. Only the user themselves can read and write their profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile if request.auth.uid == 'user123'.
     * @allow (get) User with UID 'user123' can read their profile.
     * @allow (update) User with UID 'user123' can update their profile.
     * @allow (delete) User with UID 'user123' can delete their profile.
     * @deny (create) User with UID 'user456' cannot create a profile for 'user123'.
     * @deny (get) User with UID 'user456' cannot read the profile of 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to store data. Only the store owner can read and write store data.
     * @path /stores/{storeId}
     * @allow (create) User with UID 'owner123' can create a store if they are the owner.
     * @allow (get) User with UID 'owner123' can read their store's data.
     * @allow (update) User with UID 'owner123' can update their store's data.
     * @allow (delete) User with UID 'owner123' can delete their store's data.
     * @deny (create) User with UID 'hacker456' cannot create a store owned by 'owner123'.
     * @principle Enforces document ownership for writes.
     */
    match /stores/{storeId} {
      function isOwner(storeId) {
        return request.auth.uid == get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId;
      }
       function isCreatingOwner() {
        return request.auth.uid == request.resource.data.ownerId;
      }
      allow get: if isOwner(storeId);
      allow list: if false;
      allow create: if isCreatingOwner() ;
      allow update: if isOwner(storeId);
      allow delete: if isOwner(storeId);
    }

    /**
     * @description Controls access to product data. Only the store owner can read and write product data.
     * @path /stores/{storeId}/products/{productId}
     * @allow (create) User with UID 'owner123' can create a product for their store.
     * @allow (get) Anyone can read product data.
     * @allow (update) User with UID 'owner123' can update a product for their store.
     * @allow (delete) User with UID 'owner123' can delete a product for their store.
     * @deny (create) User with UID 'hacker456' cannot create a product for 'store123'.
     * @principle Enforces document ownership for writes. Allows public read access.
     */
    match /stores/{storeId}/products/{productId} {
        function isStoreOwner(storeId) {
            return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isStoreOwner(storeId);
        allow update: if isStoreOwner(storeId);
        allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Controls access to monthly package data. Only the store owner can read and write package data.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (create) User with UID 'owner123' can create a package for their store.
     * @allow (get) Anyone can read package data.
     * @allow (update) User with UID 'owner123' can update a package for their store.
     * @allow (delete) User with UID 'owner123' can delete a package for their store.
     * @deny (create) User with UID 'hacker456' cannot create a package for 'store123'.
     * @principle Enforces document ownership for writes. Allows public read access.
     */
    match /stores/{storeId}/packages/{packageId} {
      function isStoreOwner(storeId) {
            return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
        }

        allow get: if true;
        allow list: if true;
        allow create: if isStoreOwner(storeId);
        allow update: if isStoreOwner(storeId);
        allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Controls access to order data. Only the user who placed the order can read and write order data.
     * @path /orders/{orderId}
     * @allow (create) User with UID 'user123' can create an order.
     * @allow (get) User with UID 'user123' can read their order data.
     * @allow (update) User with UID 'user123' can update their order data.
     * @allow (delete) User with UID 'user123' can delete their order data.
     * @deny (create) User with UID 'hacker456' cannot create an order for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /orders/{orderId} {
      function isOrderOwner(orderId) {
        return request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.userId;
      }
      function isCreatingOrderOwner() {
        return request.auth.uid == request.resource.data.userId;
      }

      allow get: if isOrderOwner(orderId);
      allow list: if false;
      allow create: if isCreatingOrderOwner();
      allow update: if isOrderOwner(orderId);
      allow delete: if isOrderOwner(orderId);
    }

    /**
     * @description Controls access to voice order data. Currently allows public access.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get) Anyone can read voice order data.
     * @allow (create) Anyone can create voice order data.
     * @allow (update) Anyone can update voice order data.
     * @allow (delete) Anyone can delete voice order data.
     * @principle Allows public read and write access.
     */
    match /voice-orders/{voiceOrderId} {
      allow get: if true;
      allow list: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }

    /**
     * @description Controls access to order item data. Only the user who placed the order can read and write order item data.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (create) User with UID 'user123' can create an order item for their order.
     * @allow (get) User with UID 'user123' can read their order item data.
     * @allow (update) User with UID 'user123' can update their order item data.
     * @allow (delete) User with UID 'user123' can delete their order item data.
     * @deny (create) User with UID 'hacker456' cannot create an order item for 'order123'.
     * @principle Enforces document ownership for writes.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
        function isOrderOwner(orderId) {
            return get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
        }

        allow get: if isOrderOwner(orderId);
        allow list: if false;
        allow create: if isOrderOwner(orderId);
        allow update: if isOrderOwner(orderId);
        allow delete: if isOrderOwner(orderId);
    }

    /**
     * @description Controls access to product recommendation data. Only the user for whom the recommendation is made can read and write the data.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (create) User with UID 'user123' can create a product recommendation for themselves.
     * @allow (get) User with UID 'user123' can read their product recommendation data.
     * @allow (update) User with UID 'user123' can update their product recommendation data.
     * @allow (delete) User with UID 'user123' can delete their product recommendation data.
     * @deny (create) User with UID 'hacker456' cannot create a product recommendation for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

      /**
       * @description Grants public read access to cached recipe data.
       * @path /cachedRecipes/{recipeId}
       * @allow (get) Anyone can read cached recipe data.
       * @allow (list) Anyone can list cached recipes.
       * @deny (create) No one can create cached recipe data through client.
       * @deny (update) No one can update cached recipe data through client.
       * @deny (delete) No one can delete cached recipe data through client.
       * @principle Allows public read access to cached recipe data.
       */
    match /cachedRecipes/{recipeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}