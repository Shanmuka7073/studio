/**
 * @fileoverview Firestore Security Rules for LocalBasket.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and store management,
 * with public read access for certain collections like 'stores' and 'cachedRecipes'.
 * Orders are generally not listable without authentication, but their contents can be read.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, accessible only by the user.
 * - /stores/{storeId}: Store data, publicly readable but owner-writeable.
 * - /stores/{storeId}/products/{productId}: Product data, publicly readable but owner-writeable.
 * - /orders/{orderId}: Order data, not generally listable, writeable by the user.
 * - /voice-orders/{voiceOrderId}: Voice orders, accessible to delivery partners.
 * - /deliveryPartners/{partnerId}: Delivery partner profiles, accessible only by the partner.
 * - /deliveryPartners/{partnerId}/payouts/{payoutId}: Payout requests for delivery partners, accessible only by the partner.
 * - /cachedRecipes/{recipeId}: Cached recipes, publicly readable.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Data validation is minimized in the prototyping phase for rapid iteration.
 * - Orders are generally not listable due to privacy concerns.
 * - Delivery partner data is private and only accessible to the partner.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create, get, update, delete, list) if the user's UID matches the userId in the path.
     * @deny (create) if the user's UID does not match the userId in the path.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // User listing is disabled for privacy.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to store data.
     * @path /stores/{storeId}
     * @allow (get, list) to everyone.
     * @allow (create) if the ownerId field in the request matches the user's UID.
     * @allow (update, delete) if the user is the owner of the store.
     * @deny (create, update, delete) if the user is not authenticated.
     * @principle Allows public read access to store information but restricts write access to the store owner.
     */
    match /stores/{storeId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(ownerId) {
            return request.auth.uid == ownerId;
        }

        function isExistingOwner(ownerId) {
            return isOwner(ownerId) && resource.data != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Controls access to product data within a store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get, list) to everyone.
     * @allow (create) if the store's ownerId matches the user's UID.
     * @allow (update, delete) if the user is the owner of the store.
     * @deny (create, update, delete) if the user is not authenticated.
     * @principle Allows public read access to product information but restricts write access to the store owner.
     */
    match /stores/{storeId}/products/{productId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isStoreOwner(storeId) {
            return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isStoreOwner(storeId);
        allow update: if isSignedIn() && isStoreOwner(storeId);
        allow delete: if isSignedIn() && isStoreOwner(storeId);
    }

    /**
     * @description Controls access to monthly packages within a store.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (get, list) to everyone.
     * @allow (create) if the store's ownerId matches the user's UID.
     * @allow (update, delete) if the user is the owner of the store.
     * @deny (create, update, delete) if the user is not authenticated.
     * @principle Allows public read access to package information but restricts write access to the store owner.
     */
    match /stores/{storeId}/packages/{packageId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isStoreOwner(storeId) {
            return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isStoreOwner(storeId);
        allow update: if isSignedIn() && isStoreOwner(storeId);
        allow delete: if isSignedIn() && isStoreOwner(storeId);
    }

    /**
     * @description Controls access to order data.
     * @path /orders/{orderId}
     * @allow (get) to authenticated users.
     * @allow (create) if the userId in the request matches the user's UID.
     * @deny (list) to everyone. Orders should not be generally listable.
     * @allow (update, delete) if the user is the owner of the order.
     * @principle Restricts order listing and enforces ownership for writes.
     */
    match /orders/{orderId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(orderId) {
            return get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
        }

        allow get: if isSignedIn();
        allow list: if false; // Orders should not be generally listable.
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && isOwner(orderId);
        allow delete: if isSignedIn() && isOwner(orderId);
    }

    /**
     * @description Controls access to voice order data.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get, list) to authenticated users.
     * @allow (create, update, delete) if false (no one should be able to create, update, or delete voice orders directly through the client).
     */
    match /voice-orders/{voiceOrderId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get, list: if isSignedIn();
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Controls access to order item data within an order.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) to authenticated users if they are the order owner.
     * @allow (create) if the order's userId matches the user's UID.
     * @allow (update, delete) if the user is the owner of the order.
     * @principle Enforces order ownership for order item access.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOrderOwner(orderId) {
             return get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
        }

        allow get: if isSignedIn() && isOrderOwner(orderId);
        allow list: if isSignedIn() && isOrderOwner(orderId);
        allow create: if isSignedIn() && isOrderOwner(orderId);
        allow update: if isSignedIn() && isOrderOwner(orderId);
        allow delete: if isSignedIn() && isOrderOwner(orderId);
    }

    /**
     * @description Controls access to product recommendation data for a user.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get, list) if the user's UID matches the userId in the path.
     * @allow (create, update, delete) if the user's UID matches the userId in the path.
     * @principle Enforces user ownership for product recommendations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        allow get: if isSignedIn() && isOwner(userId);
        allow list: if isSignedIn() && isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && isOwner(userId);
        allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to cached recipe data.
     * @path /cachedRecipes/{recipeId}
     * @allow (get, list) to everyone.
     * @allow (create, update, delete) if false; // TODO: Consider limiting this to admin only.
     * @principle Allows public read access to cached recipes.
     */
    match /cachedRecipes/{recipeId} {
        allow get, list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

      /**
       * @description Controls access to delivery partner data.
       * @path /deliveryPartners/{partnerId}
       * @allow (get, update) if the user's UID matches the partnerId.
       * @deny (list, create, delete) to everyone.
       * @principle Enforces that only the delivery partner can access their own profile.
       */
      match /deliveryPartners/{partnerId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(partnerId) {
          return request.auth.uid == partnerId;
        }

        allow get: if isSignedIn() && isOwner(partnerId);
        allow list: if false;
        allow create: if false;
        allow update: if isSignedIn() && isOwner(partnerId);
        allow delete: if false;
      }

      /**
       * @description Controls access to payout requests for a delivery partner.
       * @path /deliveryPartners/{partnerId}/payouts/{payoutId}
       * @allow (get, list, create) if the user's UID matches the partnerId.
       * @deny (update, delete) to everyone.
       * @principle Enforces that only the delivery partner can create and read their payout requests.
       */
      match /deliveryPartners/{partnerId}/payouts/{payoutId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(partnerId) {
          return request.auth.uid == partnerId;
        }

        allow get: if isSignedIn() && isOwner(partnerId);
        allow list: if isSignedIn() && isOwner(partnerId);
        allow create: if isSignedIn() && isOwner(partnerId);
        allow update: if false;
        allow delete: if false;
      }
  }
}