/**
 * @fileoverview Firestore Security Rules for LocalBasket.
 *
 * Core Philosophy:
 * This ruleset enforces a mixed security model. User data is strictly controlled by the individual user.
 * Orders can be updated by the store owner, but created by the customer (based on userId matching).
 * Other collections have varying levels of access, with public read access where appropriate and owner-only writes.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, accessible only by the user.
 * - /stores/{storeId}: Store data, publicly readable.
 * - /stores/{storeId}/products/{productId}: Product data, publicly readable, writeable only by store owner.
 * - /stores/{storeId}/packages/{packageId}: Package data, publicly readable, writeable only by store owner.
 * - /orders/{orderId}: Order data, readable by the user and store owner, updateable only by the store owner.
 * - /voice-orders/{voiceOrderId}: Voice order data, publicly readable.
 * - /orders/{orderId}/orderItems/{orderItemId}: Order item data, publicly readable.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Product recommendations, accessible only by the user.
 * - /cachedRecipes/{recipeId}: Cached recipes, publicly readable.
 *
 * Key Security Decisions:
 * - Users can only access their own data under /users/{userId}.
 * - Stores and products are publicly readable to facilitate browsing.
 * - Orders can be updated by store owners to allow for status updates.
 * - Listing of users is disallowed.
 * - No data shape validation is enforced in this prototyping phase.
 *
 * Denormalization for Authorization:
 * - The 'Order' entity contains 'userId' and 'storeId' to allow simpler authorization checks.
 * - The 'OrderItem' entity contains 'orderId' to make it independent of the parent order for authorization.
 * - The 'ProductRecommendation' entity contains 'userId' to make authorization checks simpler.
 *
 * Structural Segregation:
 * - No explicit structural segregation is applied in this ruleset.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their profile.
     * @allow (get, list, update, delete) User with matching UID can access their profile.
     * @deny (create, update, delete) User cannot modify another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is disallowed
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to store data.
     * @path /stores/{storeId}
     * @allow (get, list) Anyone can read store data.
     * @allow (create) Store owner with matching UID can create store data.
     * @allow (update, delete) Store owner with matching UID can update or delete store data.
     * @deny (create, update, delete) Non-owners cannot modify store data.
     * @principle Allows public read access with owner-only writes for stores.
     */
    match /stores/{storeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(storeId) {
          return isSignedIn() && resource.data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid; // Owner ID validation happens in the rules
      allow update: if isSignedIn() && isOwner(storeId);
      allow delete: if isSignedIn() && isOwner(storeId);
    }

    /**
     * @description Controls access to product data within a store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get, list) Anyone can read product data.
     * @allow (create) Store owner with matching storeId can create product data.
     * @allow (update, delete) Store owner with matching storeId can update or delete product data.
     * @deny (create, update, delete) Non-owners cannot modify product data.
     * @principle Allows public read access with owner-only writes for products.
     */
    match /stores/{storeId}/products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isStoreOwner(storeId) {
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isStoreOwner(storeId);
      allow update: if isSignedIn() && isStoreOwner(storeId);
      allow delete: if isSignedIn() && isStoreOwner(storeId);
    }

    /**
     * @description Controls access to monthly package data within a store.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (get, list) Anyone can read monthly package data.
     * @allow (create) Store owner with matching storeId can create monthly package data.
     * @allow (update, delete) Store owner with matching storeId can update or delete monthly package data.
     * @deny (create, update, delete) Non-owners cannot modify monthly package data.
     * @principle Allows public read access with owner-only writes for monthly packages.
     */
    match /stores/{storeId}/packages/{packageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isStoreOwner(storeId) {
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isStoreOwner(storeId);
      allow update: if isSignedIn() && isStoreOwner(storeId);
      allow delete: if isSignedIn() && isStoreOwner(storeId);
    }

    /**
     * @description Controls access to order data.
     * @path /orders/{orderId}
     * @allow (get, list) Anyone can read order data.
     * @allow (create) User with matching UID can create order data.
     * @allow (update, delete) Store owner with matching storeId can update or delete order data.
     * @deny (create, update, delete) Non-owners cannot modify order data.
     * @principle Allows public read access with owner-only writes for orders by store owner.
     */
    match /orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOrderOwner(orderId) {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }

      function isStoreOwner(orderId) {
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId == request.auth.uid;
      }

        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && isStoreOwner(orderId);
        allow delete: if isSignedIn() && isStoreOwner(orderId);
    }

    /**
     * @description Controls access to voice order data.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get, list) Anyone can read voice order data.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Allows public read access, but no write access for voice orders.
     */
    match /voice-orders/{voiceOrderId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to order item data within an order.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) Anyone can read order item data.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Allows public read access, but no write access for order items.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to product recommendation data for a user.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get, list) User with matching UID can access their product recommendations.
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @deny (create, update, delete) User cannot modify another user's product recommendations.
     * @principle Enforces document ownership for product recommendations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

       /**
     * @description Controls access to cached recipe data.
     * @path /cachedRecipes/{recipeId}
     * @allow (get, list) Anyone can read cached recipe data.
     * allow create: if false;
     * allow update: if false;
     * allow delete: if false;
     */
    match /cachedRecipes/{recipeId} {
      allow get, list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}