/**
 * @fileoverview Firestore Security Rules for LocalBasket Prototype
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization based on user identity and
 * relationships between entities. Data validation is relaxed to enable rapid
 * prototyping and iteration.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, accessible only by the user themselves.
 * - /stores/{storeId}: Store data, writeable only by the store owner.
 * - /stores/{storeId}/products/{productId}: Product data for a store.
 * - /stores/{storeId}/packages/{packageId}: Monthly package deals for a store.
 * - /orders/{orderId}: Order information, readable by anyone, writeable only by the assigning deliveryPartner.
 * - /voice-orders/{voiceOrderId}: Voice orders, readable by anyone.
 * - /orders/{orderId}/orderItems/{orderItemId}: Items within an order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Product recommendations for a user.
 * - /cachedRecipes/{recipeId}: Cached recipes for AI reduction, publicly readable and writeable.
 * - /deliveryPartners/{partnerId}: Delivery partner information, where partnerId is the same as userId.
 * - /deliveryPartners/{partnerId}/payouts/{payoutId}: Payout requests for a delivery partner.
 *
 * Key Security Decisions:
 * - User data is strictly private.
 * - Listing all users is disallowed.
 * - Public read access is granted to some collections, but write access is carefully controlled.
 * - The rules rely on denormalized data to make authorization checks efficient.
 *
 * Denormalization for Authorization:
 * - The 'Order' entity includes 'userId' and 'storeId' to facilitate authorization checks without additional reads.
 * - The 'OrderItem' entity includes 'orderId' to ensure that order items are only accessible in the context of their parent order.
 * - 'ProductRecommendation' includes the 'userId' to keep recommendations private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profile data. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create, get, update, delete, list) if the request is made by the user with matching userId.
     *   Example: request.auth.uid == 'user123' and path includes '/users/user123'.
     * @deny (create, get, update, delete, list) if the request is made by a different user or not authenticated.
     *   Example: request.auth.uid == 'user456' but path includes '/users/user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get, update, delete: if isOwner(userId);
      allow list: if false; // Listing users is not allowed.
      allow create: if isOwner(userId);
    }

    /**
     * @description Manages store data. Only the store owner can create, read, update, or delete store information.
     * @path /stores/{storeId}
     * @allow (create, get, update, delete, list) if the request is made by the owner of the store.
     *   Example: The request.auth.uid matches the store's ownerId field.
     * @deny (create, get, update, delete, list) if the request is made by a non-owner.
     *   Example: The request.auth.uid does not match the store's ownerId field.
     * @principle Enforces document ownership for all write operations on stores.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if request.auth.uid == resource.data.ownerId;
    }

    /**
     * @description Manages product data within a store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (create, update, delete) if the request is made by the owner of the store.
     *   The rule checks if request.auth.uid matches the ownerId field of the parent store document.
     * @allow (get, list) if the request is made by anyone. Products are publicly readable.
     * @deny (create, update, delete) if the request is made by a non-owner.
     * @principle Enforces store ownership for product modifications, allows public read access.
     */
    match /stores/{storeId}/products/{productId} {
        function isStoreOwner(storeId) {
            return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create, update, delete: if request.auth != null && isStoreOwner(storeId);
    }

    /**
     * @description Manages monthly package deals for a store.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (create, update, delete) if the request is made by the owner of the store.
     *   The rule checks if request.auth.uid matches the ownerId field of the parent store document.
     * @allow (get, list) if the request is made by anyone. Monthly packages are publicly readable.
     * @deny (create, update, delete) if the request is made by a non-owner.
     * @principle Enforces store ownership for package modifications, allows public read access.
     */
    match /stores/{storeId}/packages/{packageId} {
        function isStoreOwner(storeId) {
            return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create, update, delete: if request.auth != null && isStoreOwner(storeId);
    }

    /**
     * @description Manages order data.
     * @path /orders/{orderId}
     * @allow (get, list) if the request is made by anyone. Orders are publicly readable.
     * @allow update if the deliveryPartnerId is the authenticated user
     * @deny (create, delete) at all times. Orders cannot be created nor deleted directly through the API, but through backend cloud functions instead.
     * @principle Allow the delivery partner who is assigned to the order to change order status.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if request.auth != null && request.resource.data.deliveryPartnerId == request.auth.uid;
      allow delete: if false;
    }

    /**
     * @description Manages voice-only orders.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get, list) if the request is made by anyone. Voice orders are publicly readable.
     * @deny (create, update, delete) at all times.
     */
    match /voice-orders/{voiceOrderId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages order item data within an order.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) if the request is made by anyone. Order items are publicly readable.
     * @deny (create, update, delete) at all times.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages product recommendations for a user.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get, list, create, update, delete) if the request is made by the user with matching userId.
     * @deny (get, list, create, update, delete) if the request is made by a different user or not authenticated.
     * @principle Enforces user-specific access for product recommendations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get, list, create, update, delete: if isOwner(userId);
    }

    /**
     * @description Manages cached recipes. Allows public read and write access.
     * @path /cachedRecipes/{recipeId}
     * @allow (get, list, create, update, delete) if true.
     * @principle Provides public access to cached recipe data.
     */
    match /cachedRecipes/{recipeId} {
      allow get, list, create, update, delete: if true;
    }

    /**
     * @description Manages delivery partner information. The document ID is the partner's user ID.
     * @path /deliveryPartners/{partnerId}
     * @allow get, update, delete: if isOwner(partnerId)
     * @allow create: if request.auth != null && request.auth.uid == partnerId;
     * @deny list: if false; // not allowed
     * @principle Enforces document ownership: only the partner can access their own record.
     */
    match /deliveryPartners/{partnerId} {
      function isOwner(partnerId) {
        return request.auth != null && request.auth.uid == partnerId;
      }
      allow get, update, delete: if isOwner(partnerId);
      allow create: if isOwner(partnerId);
      allow list: if false;
    }

    /**
     * @description Manages payout requests for a delivery partner.
     * @path /deliveryPartners/{partnerId}/payouts/{payoutId}
     * @allow get, list, create: if request.auth != null && request.auth.uid == partnerId;
     * @deny update, delete: if false;
     * @principle Enforces that only the delivery partner can request payouts.
     */
    match /deliveryPartners/{partnerId}/payouts/{payoutId} {
      function isOwner(partnerId) {
        return request.auth != null && request.auth.uid == partnerId;
      }
      allow get, list, create: if isOwner(partnerId);
      allow update, delete: if false;
    }
  }
}