/**
 * @fileoverview Firestore Security Rules for LocalBasket.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and their associated data,
 * with stores being owned by individual users. Orders are linked to both users and stores.
 * Voice orders are publicly accessible. Product recommendations are specific to each user.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only by the user themselves.
 * - /stores/{storeId}: Stores data related to each store, owned by a user.
 * - /stores/{storeId}/products/{productId}: Stores product information for each store, accessible only by the store owner.
 * - /orders/{orderId}: Stores order information, accessible only by the user who placed the order.
 * - /voice-orders/{voiceOrderId}: Stores voice-only orders; publicly accessible.
 * - /orders/{orderId}/orderItems/{orderItemId}: Stores order items for each order, accessible only by the user who placed the order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Stores product recommendations for each user, accessible only by the user themselves.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data.
 * - Stores can only be created, updated, or deleted by their owners.
 * - Products can only be created, updated, or deleted by the store owner.
 * - Orders can only be created, updated, or deleted by the user who placed the order.
 * - Voice orders are publicly readable.
 * - Product recommendations can only be accessed by the user they are for.
 *
 * Denormalization for Authorization:
 * - Orders include 'userId' to easily verify the user placing the order.
 * - Stores include 'ownerId' to quickly verify the store owner.
 *
 * Structural Segregation:
 * - Voice orders are stored in a separate top-level collection to allow for public read access without compromising the security of other data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) request.auth.uid == 'user_abc' with matching document ID
     * @allow (get, update, delete) request.auth.uid == 'user_abc'
     * @deny (create) request.auth.uid != 'user_abc'
     * @deny (get, update, delete) request.auth.uid != 'user_abc'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows store owners to manage their store data.
     * @path /stores/{storeId}
     * @allow (create) request.auth.uid == 'user_abc' with matching ownerId
     * @allow (get, update, delete) request.auth.uid == 'user_abc' where the user is the store owner.
     * @deny (create) request.auth.uid != 'user_abc' or mismatched ownerId
     * @deny (get, update, delete) request.auth.uid != 'user_abc' or not the store owner.
     * @principle Enforces document ownership for writes.
     */
    match /stores/{storeId} {
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.ownerId == request.auth.uid;
      allow update: if isOwner(resource.data.ownerId) && resource != null;
      allow delete: if isOwner(resource.data.ownerId) && resource != null;
    }

    /**
     * @description Allows store owners to manage their product listings.
     * @path /stores/{storeId}/products/{productId}
     * @allow (create) request.auth.uid == 'user_abc' if the user owns the store.
     * @allow (get, update, delete) request.auth.uid == 'user_abc' if the user owns the store.
     * @deny (create) request.auth.uid != 'user_abc' or user doesn't own the store.
     * @deny (get, update, delete) request.auth.uid != 'user_abc' or user doesn't own the store.
     * @principle Enforces document ownership for writes.
     */
    match /stores/{storeId}/products/{productId} {
      function isStoreOwner(storeId) {
        return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isStoreOwner(storeId);
      allow update: if isStoreOwner(storeId) && resource != null;
      allow delete: if isStoreOwner(storeId) && resource != null;
    }

    /**
     * @description Allows users to manage their orders.
     * @path /orders/{orderId}
     * @allow (create) request.auth.uid == 'user_abc' if the order's userId matches the user's ID.
     * @allow (get, update, delete) request.auth.uid == 'user_abc' if the order's userId matches the user's ID.
     * @deny (create) request.auth.uid != 'user_abc' or mismatched userId.
     * @deny (get, update, delete) request.auth.uid != 'user_abc' or mismatched userId.
     * @principle Enforces document ownership for writes.
     */
    match /orders/{orderId} {
      function isOrderOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOrderOwner(resource.data.userId);
      allow list: if isOrderOwner(resource.data.userId);
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update: if isOrderOwner(resource.data.userId) && resource != null;
      allow delete: if isOrderOwner(resource.data.userId) && resource != null;
    }

    /**
     * @description Allows public read access to voice orders.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get, list): Public read access.
     * @deny (create, update, delete): No public write access.
     * @principle Provides public read access to voice orders.
     */
    match /voice-orders/{voiceOrderId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows users to manage their order items.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (create) request.auth.uid == 'user_abc' if the parent order's userId matches the user's ID.
     * @allow (get, update, delete) request.auth.uid == 'user_abc' if the parent order's userId matches the user's ID.
     * @deny (create) request.auth.uid != 'user_abc' or mismatched userId.
     * @deny (get, update, delete) request.auth.uid != 'user_abc' or mismatched userId.
     * @principle Enforces document ownership for writes.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      function isOrderOwner(orderId) {
        return get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      }
      allow get: if isOrderOwner(orderId);
      allow list: if isOrderOwner(orderId);
      allow create: if isOrderOwner(orderId);
      allow update: if isOrderOwner(orderId) && resource != null;
      allow delete: if isOrderOwner(orderId) && resource != null;
    }

    /**
     * @description Allows users to access their product recommendations.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (create) request.auth.uid == 'user_abc' if the recommendation's userId matches the user's ID.
     * @allow (get, update, delete) request.auth.uid == 'user_abc' if the recommendation's userId matches the user's ID.
     * @deny (create) request.auth.uid != 'user_abc' or mismatched userId.
     * @deny (get, update, delete) request.auth.uid != 'user_abc' or mismatched userId.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if request.resource.data.userId == request.auth.uid && isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }
  }
}