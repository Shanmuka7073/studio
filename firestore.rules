/**
 * @file Firestore Security Rules for LocalBasket
 * @version Prototyping
 *
 * @description
 * This ruleset enforces a strict user-ownership model for user profiles and associated data,
 * while allowing public read access to stores and products. Orders are restricted to the user
 * who created them.
 *
 * @dataStructure
 * - /users/{userId}: User profile data, accessible only by the user.
 * - /stores/{storeId}: Store data, publicly readable.
 * - /stores/{storeId}/products/{productId}: Product data, publicly readable.
 * - /orders/{orderId}: Order data, accessible only by the user who placed the order.
 * - /voice-orders/{voiceOrderId}: Voice order data. Accessible by delivery partners for fulfillment.
 * - /orders/{orderId}/orderItems/{orderItemId}: Order items for each order, accessible only by the user who placed the order.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Product recommendations for each user, accessible only by the user.
 * - /cachedRecipes/{recipeId}: Cached recipe ingredients to reduce AI usage. Publicly readable.
 *
 * @keySecurityDecisions
 * - User listing is disallowed.
 * - Public read access is granted for stores and products.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * @denormalizationForAuthorization
 * - Orders include the 'userId' field to allow for easy owner-based security rules without needing to perform additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Grants access to user profiles only to the user themselves.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile if request.auth.uid == 'user123'.
     * @allow (get) User with ID 'user123' can read their profile if request.auth.uid == 'user123'.
     * @allow (update) User with ID 'user123' can update their profile if request.auth.uid == 'user123'.
     * @allow (delete) User with ID 'user123' can delete their profile if request.auth.uid == 'user123'.
     * @deny (create) User with ID 'user456' cannot create profile with ID 'user123'.
     * @deny (get) User with ID 'user456' cannot read user profile with ID 'user123'.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to store data and restricts writes to store owners.
     * @path /stores/{storeId}
     * @allow (get) Any user can read store data.
     * @allow (list) Any user can list store data.
     * @allow (create) Store owner with ID 'user123' can create store data if request.auth.uid == request.resource.data.ownerId.
     * @allow (update) Store owner with ID 'user123' can update store data if resource.data.ownerId == request.auth.uid.
     * @allow (delete) Store owner with ID 'user123' can delete store data if resource.data.ownerId == request.auth.uid.
     * @deny (create) User with ID 'user456' cannot create store data with ownerId 'user123'.
     * @deny (update) User with ID 'user456' cannot update store data with ownerId 'user234'.
     * @principle Allows public read access while enforcing ownership for write operations.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Allows public read access to product data and restricts writes to store owners.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get) Any user can read product data.
     * @allow (list) Any user can list product data.
     * @allow (create) Store owner can create product data under their store.
     * @allow (update) Store owner can update product data under their store.
     * @allow (delete) Store owner can delete product data under their store.
     * @deny (create) Non-store owner cannot create product data.
     * @deny (update) Non-store owner cannot update product data.
     * @principle Allows public read access while enforcing ownership for write operations.
     */
    match /stores/{storeId}/products/{productId} {
      function isStoreOwner(storeId) {
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if true;
      allow create: if isStoreOwner(storeId);
      allow update: if isStoreOwner(storeId);
      allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Grants access to monthly package deals only to the store owners.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (get) Store owner can get package data.
     * @allow (list) Store owner can list package data.
     * @allow (create) Store owner can create package data under their store.
     * @allow (update) Store owner can update package data under their store.
     * @allow (delete) Store owner can delete package data under their store.
     * @deny (create) Non-store owner cannot create package data.
     * @deny (update) Non-store owner cannot update package data.
     * @principle Allows store owner to manage monthly packages
     */
    match /stores/{storeId}/packages/{packageId} {
      function isStoreOwner(storeId) {
        return isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

      allow get, list: if isStoreOwner(storeId);
      allow create: if isStoreOwner(storeId);
      allow update: if isStoreOwner(storeId);
      allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Grants access to order data only to the user who placed the order.
     * @path /orders/{orderId}
     * @allow (get) User with ID 'user123' can read order data if request.auth.uid == resource.data.userId.
     * @allow (list) User with ID 'user123' can list order data if request.auth.uid == resource.data.userId.
     * @allow (create) User with ID 'user123' can create order data if request.auth.uid == request.resource.data.userId.
     * @allow (update) User with ID 'user123' can update order data if request.auth.uid == resource.data.userId.
     * @allow (delete) User with ID 'user123' can delete order data if request.auth.uid == resource.data.userId.
     * @deny (get) User with ID 'user456' cannot read order data with userId 'user123'.
     * @deny (create) User with ID 'user456' cannot create order data with userId 'user123'.
     * @principle Enforces document ownership for all operations on order data.
     */
    match /orders/{orderId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Grants access to voice order data for delivery partners for fulfillment.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get) Delivery partners can read voice order data.
     * @allow (list) Delivery partners can list voice order data.
     * @allow (create) Anyone can create voice order data.
     * @allow (update) Anyone can update voice order data.
     * @allow (delete) Anyone can delete voice order data.
     * @principle Allows open read/write access for voice orders.
     */
    match /voice-orders/{voiceOrderId} {
      allow get, list, create, update, delete: if true;
    }

    /**
     * @description Grants access to order item data only to the user who placed the order.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get) User with ID 'user123' can read order item data if request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.userId.
     * @allow (list) User with ID 'user123' can list order item data if request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.userId.
     * @allow (create) User with ID 'user123' can create order item data if request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.userId.
     * @allow (update) User with ID 'user123' can update order item data if request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.userId.
     * @allow (delete) User with ID 'user123' can delete order item data if request.auth.uid == get(/databases/$(database)/documents/orders/$(orderId)).data.userId.
     * @deny (get) User with ID 'user456' cannot read order item data with orderId associated with user 'user123'.
     * @deny (create) User with ID 'user456' cannot create order item data with orderId associated with user 'user123'.
     * @principle Enforces document ownership for all operations on order item data.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      function isOrderOwner(orderId) {
        return isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid;
      }

      allow get, list: if isOrderOwner(orderId);
      allow create: if isOrderOwner(orderId);
      allow update: if isOrderOwner(orderId);
      allow delete: if isOrderOwner(orderId);
    }

    /**
     * @description Grants access to product recommendations only to the user for whom the recommendations are made.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get) User with ID 'user123' can read recommendation data if request.auth.uid == userId.
     * @allow (list) User with ID 'user123' can list recommendation data if request.auth.uid == userId.
     * @allow (create) User with ID 'user123' can create recommendation data if request.auth.uid == userId.
     * @allow (update) User with ID 'user123' can update recommendation data if request.auth.uid == userId.
     * @allow (delete) User with ID 'user123' can delete recommendation data if request.auth.uid == userId.
     * @deny (get) User with ID 'user456' cannot read recommendation data for user 'user123'.
     * @deny (create) User with ID 'user456' cannot create recommendation data for user 'user123'.
     * @principle Enforces document ownership for all operations on product recommendations.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to cached recipe data.
     * @path /cachedRecipes/{recipeId}
     * @allow (get) Any user can read recipe data.
     * @allow (list) Any user can list recipe data.
     * @allow (create) Any user can create recipe data.
     * @allow (update) Any user can update recipe data.
     * @allow (delete) Any user can delete recipe data.
     * @principle Allows public read access while enforcing ownership for write operations.
     */
    match /cachedRecipes/{recipeId} {
      allow get, list, create, update, delete: if true;
    }
  }
}