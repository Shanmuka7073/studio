/**
 * @fileoverview Firestore Security Rules for LocalBasket application.
 *
 * Core Philosophy:
 * This ruleset employs a hybrid security model, balancing user-owned data with publicly accessible content. User profiles and recommendations are strictly private, while stores and products are readable by everyone. Orders and VoiceOrders are accessible for all, but writes are restricted.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, accessible only by the user.
 * - /stores/{storeId}: Store information, publicly readable, owner-writeable.
 * - /stores/{storeId}/products/{productId}: Product information, publicly readable, owner-writeable.
 * - /orders/{orderId}: Order information, publicly readable, writes are restricted
 * - /voice-orders/{voiceOrderId}: Voice order information, publicly readable, writes are restricted.
 * - /orders/{orderId}/orderItems/{orderItemId}: Order item information, publicly readable, writes are restricted.
 * - /users/{userId}/productRecommendations/{productRecommendationId}: Product recommendations, private to the user.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data.
 * - Stores and Products are publicly readable but only the store owner can modify them.
 * - Orders and VoiceOrders are publicly listable, create, update, delete are restricted
 * - Product recommendations are private to the user.
 *
 * Denormalization for Authorization:
 * - The `Store` entity contains an `ownerId` field, enabling simple ownership checks for store and product writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with matching userId can create their profile.
     * @allow (get, list, update, delete) User with matching userId can read and modify their profile.
     * @deny (create) User cannot create a profile with a mismatched userId.
     * @deny (update, delete) User cannot modify or delete another user's profile.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to store data.
     * @path /stores/{storeId}
     * @allow (get, list) Anyone can read store information.
     * @allow (create) Store owner can create a store.
     * @allow (update, delete) Store owner can modify or delete their store.
     * @deny (create) Non-owners cannot create stores.
     * @deny (update, delete) Non-owners cannot modify or delete stores.
     * @principle Enforces owner-only writes for stores.
     */
    match /stores/{storeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }

       function isExistingOwner(ownerId) {
        return isSignedIn() && request.auth.uid == resource.data.ownerId && resource.data != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
    }

    /**
     * @description Controls access to product data within a store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get, list) Anyone can read product information.
     * @allow (create) Store owner can create a product.
     * @allow (update, delete) Store owner can modify or delete their product.
     * @deny (create) Non-owners cannot create products.
     * @deny (update, delete) Non-owners cannot modify or delete products.
     * @principle Enforces owner-only writes for products within a store.
     */
    match /stores/{storeId}/products/{productId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isStoreOwner(storeId) {
        return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
      }

       function isExistingStoreOwner(storeId) {
        return isSignedIn() && isStoreOwner(storeId) && resource.data != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isStoreOwner(storeId);
      allow update: if isSignedIn() && isStoreOwner(storeId);
      allow delete: if isSignedIn() && isStoreOwner(storeId);
    }

    /**
     * @description Controls access to order data.
     * @path /orders/{orderId}
     * @allow (get, list) Anyone can read order information.
     * @deny (create, update, delete) No one can create, update, or delete orders through client-side rules.
     * @principle Restricts order creation, modification, and deletion to backend services.
     */
    match /orders/{orderId} {
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
     * @description Controls access to voice order data.
     * @path /voice-orders/{voiceOrderId}
     * @allow (get, list) Anyone can read voice order information.
     * @deny (create, update, delete) No one can create, update, or delete voice orders through client-side rules.
     * @principle Restricts voice order creation, modification, and deletion to backend services.
     */
    match /voice-orders/{voiceOrderId} {
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to order item data within an order.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) Anyone can read order item information.
     * @deny (create, update, delete) No one can create, update, or delete order items through client-side rules.
     * @principle Restricts order item creation, modification, and deletion to backend services.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to product recommendation data for a user.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get, list) User with matching userId can read their product recommendations.
     * @deny (create, update, delete) Only backend services can create, update, or delete product recommendations.
     * @principle Restricts management of product recommendations to backend services, but allows user-specific read access.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}