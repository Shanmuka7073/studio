/**
 * @file Firestore Security Rules for LocalBasket
 * @version Prototyping
 *
 * @Core Philosophy:
 * This ruleset prioritizes secure authorization based on user identity and resource ownership,
 * while relaxing data validation to enable rapid prototyping. Data shapes are not strictly enforced.
 *
 * @Data Structure:
 * - `/users/{userId}`: User profiles, accessible only to the owning user.
 * - `/stores/{storeId}`: Store information, owner-writeable, publicly readable.
 * - `/stores/{storeId}/products/{productId}`: Products listed by a store, owner-writeable, publicly readable.
 * - `/stores/{storeId}/packages/{packageId}`: Monthly packages offered by a store, owner-writeable, publicly readable.
 * - `/orders/{orderId}`: Order information, writeable by the user who created the order.
 * - `/voice-orders/{voiceOrderId}`: Voice orders, open for prototyping.
 * - `/orders/{orderId}/orderItems/{orderItemId}`: Items within an order, owner-writeable, publicly readable.
 * - `/users/{userId}/productRecommendations/{productRecommendationId}`: Product recommendations for a user, only accessible by the user.
 * - `/cachedRecipes/{recipeId}`: Cached recipe data, publicly readable, but write-protected for now.
 *
 * @Key Security Decisions:
 * - User listing is disallowed.
 * - Read-only collections (if any) are explicitly marked.
 * - Ambiguous relationships default to strict owner-only access.
 * - Data validation is minimized for rapid prototyping and is limited to authorization-critical fields.
 * - All write operations validate resource existence to prevent accidental changes to non-existent data.
 *
 * @Denormalization for Authorization:
 * - The `Order` document contains denormalized `userId` and `storeId` fields to simplify authorization rules.
 * - The `OrderItem` document contains a denormalized `orderId` field.
 * - The `Product` document contains a denormalized `storeId` field.
 * - The `ProductRecommendation` document contains a denormalized `userId` field.
 *
 * @Structural Segregation:
 * - Drafts vs. published content are not explicitly segregated in this version.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for user profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, list, update, delete) - Authenticated user can only access their own profile.
     * @deny (create) - If the userId does not match the authenticated user's uid.
     * @deny (update, delete) - If the user is not the owner of the profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for store data.
     * @path /stores/{storeId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the store owner can create a store.
     * @allow (update, delete) - Only the store owner can update/delete the store.
     * @deny (create, update, delete) - If the user is not the owner of the store.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Rule for product data within a store.
     * @path /stores/{storeId}/products/{productId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the store owner can create a product.
     * @allow (update, delete) - Only the store owner can update/delete the product.
     * @deny (create, update, delete) - If the user is not the owner of the store.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /stores/{storeId}/products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && request.resource.data.storeId == storeId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && request.resource.data.storeId == storeId && resource != null;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && resource != null;
    }

    /**
     * @description Rule for monthly package data within a store.
     * @path /stores/{storeId}/packages/{packageId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the store owner can create a package.
     * @allow (update, delete) - Only the store owner can update/delete the package.
     * @deny (create, update, delete) - If the user is not the owner of the store.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /stores/{storeId}/packages/{packageId} {
      allow get, list: if true;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && request.resource.data.storeId == storeId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && request.resource.data.storeId == storeId && resource != null;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid && resource != null;
    }

    /**
     * @description Rule for order data.
     * @path /orders/{orderId}
     * @allow (get) - Anyone can get an order.
     * @allow (list) - Anyone can list orders.
     * @allow (create) - Only the user who is placing the order can create an order.
     * @allow (update, delete) - Only the user who created the order can update/delete the order.
     * @deny (create, update, delete) - If the user is not the owner of the order.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /orders/{orderId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.userId);
      allow delete: if isExistingOwner(resource.data.userId);
    }

     /**
      * @description Rule for voice order data. Open for prototyping.
      * @path /voice-orders/{voiceOrderId}
      * @allow get, list, create, update, delete: if true;
      * @principle Open access for prototyping.
      */
    match /voice-orders/{voiceOrderId} {
          allow get, list, create, update, delete: if true;
    }

    /**
     * @description Rule for order item data within an order.
     * @path /orders/{orderId}/orderItems/{orderItemId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the user who placed the order can create an order item.
     * @allow (update, delete) - Only the user who created the order can update/delete the order item.
     * @deny (create, update, delete) - If the user is not the owner of the order.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /orders/{orderId}/orderItems/{orderItemId} {
      allow get, list: if true;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid && request.resource.data.orderId == orderId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid && request.resource.data.orderId == orderId && resource != null;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid && resource != null;
    }

    /**
     * @description Rule for product recommendation data within a user profile.
     * @path /users/{userId}/productRecommendations/{productRecommendationId}
     * @allow (get, list) - Only the user can access their own recommendations.
     * @allow (create) - Only the user can create a recommendation for themselves if the userId matches their auth.uid.
     * @allow (update, delete) - Only the user can update/delete their own recommendations.
     * @deny (create) - If the userId does not match the authenticated user's uid.
     * @deny (update, delete) - If the user is not the owner of the recommendations.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/productRecommendations/{productRecommendationId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId) && request.resource.data.userId == userId;
    }

     /**
      * @description Rule for cached recipe data.
      * @path /cachedRecipes/{recipeId}
      * @allow get, list: if true;
      * @allow create, update, delete: if false;
      * @principle Public read access, write-protected.
      */
    match /cachedRecipes/{recipeId} {
          allow get, list: if true;
          allow create, update, delete: if false;
    }
  }
}